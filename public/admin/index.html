<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Hotel Can Quetglas</title>
  <link href="https://fonts.cdnfonts.com/css/coco-gothic" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --cream: #FAF8F5; --white: #FFFFFF; --sand: #F0EBE3; --gold: #B8956B; --charcoal: #2C2C2C; --gray: #6B6B6B; --gray-light: #A0A0A0; --success: #4ade80; --danger: #ef4444; }
    body { font-family: 'Coco Gothic', sans-serif; background: var(--cream); color: var(--charcoal); min-height: 100vh; }
    
    .header { background: var(--white); border-bottom: 1px solid var(--sand); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .header-brand { display: flex; align-items: center; gap: 20px; }
    .header-brand img { height: 40px; }
    .header-title { font-size: 18px; letter-spacing: 3px; }
    .header-title span { color: var(--gold); font-size: 10px; letter-spacing: 2px; display: block; margin-top: 4px; text-transform: uppercase; }
    .header-actions { display: flex; gap: 15px; }
    
    .btn { padding: 12px 24px; border: none; font-size: 12px; font-weight: 400; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; letter-spacing: 2px; text-transform: uppercase; font-family: inherit; }
    .btn-primary { background: var(--gold); color: var(--white); }
    .btn-primary:hover { background: #a07d5a; }
    .btn-secondary { background: var(--white); color: var(--charcoal); border: 1px solid var(--sand); }
    .btn-secondary:hover { border-color: var(--gold); }
    .btn-danger { background: var(--danger); color: var(--white); }
    .btn-small { padding: 8px 16px; font-size: 11px; }
    
    .main { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
    
    .tabs { display: flex; gap: 0; margin-bottom: 40px; border-bottom: 1px solid var(--sand); }
    .tab { padding: 16px 30px; border: none; background: none; font-size: 11px; color: var(--gray); cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 2px; position: relative; font-family: inherit; }
    .tab:hover { color: var(--charcoal); }
    .tab.active { color: var(--gold); }
    .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--gold); }
    
    .section { display: none; }
    .section.active { display: block; }
    
    .card { background: var(--white); border: 1px solid var(--sand); padding: 30px; margin-bottom: 25px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--sand); }
    .card-title { font-size: 16px; letter-spacing: 2px; font-weight: 400; }
    
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group.full-width { grid-column: 1 / -1; }
    label { font-size: 10px; color: var(--gray); text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; gap: 8px; }
    .lang-badge { font-size: 9px; padding: 3px 8px; letter-spacing: 1px; }
    .lang-badge.es { background: #fef3c7; color: #92400e; }
    .lang-badge.en { background: #dbeafe; color: #1e40af; }
    .lang-badge.de { background: #fce7f3; color: #9d174d; }
    input, textarea, select { padding: 14px 16px; background: var(--cream); border: 1px solid var(--sand); color: var(--charcoal); font-size: 14px; font-family: inherit; transition: all 0.3s; letter-spacing: 0.5px; }
    input:focus, textarea:focus { outline: none; border-color: var(--gold); background: var(--white); }
    textarea { resize: vertical; min-height: 90px; }
    
    .items-list { display: flex; flex-direction: column; gap: 10px; }
    .item-row { display: grid; grid-template-columns: 45px 1fr 1fr 100px 90px; gap: 15px; align-items: center; padding: 18px; background: var(--cream); border: 1px solid transparent; transition: all 0.3s; }
    .item-row:hover { border-color: var(--gold); }
    .item-icon { width: 45px; height: 45px; border: 1px solid var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .item-name { font-size: 14px; letter-spacing: 1px; }
    .item-detail { color: var(--gray); font-size: 13px; }
    .item-actions { display: flex; gap: 8px; justify-content: flex-end; }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { background: var(--white); border: 1px solid var(--sand); padding: 35px; width: 90%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--sand); }
    .modal-title { font-size: 18px; letter-spacing: 2px; font-weight: 400; }
    .modal-close { width: 35px; height: 35px; border: 1px solid var(--sand); background: none; cursor: pointer; font-size: 18px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { border-color: var(--gold); color: var(--gold); }
    .modal-footer { display: flex; justify-content: flex-end; gap: 12px; margin-top: 25px; padding-top: 25px; border-top: 1px solid var(--sand); }
    
    .toast { position: fixed; bottom: 30px; right: 30px; background: var(--white); border: 1px solid var(--gold); color: var(--charcoal); padding: 16px 24px; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 2000; font-size: 13px; letter-spacing: 1px; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--danger); }
    
    .icon-selector { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 8px; }
    .icon-option { width: 45px; height: 45px; border: 1px solid var(--sand); background: var(--cream); cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
    .icon-option:hover { border-color: var(--gold); }
    .icon-option.selected { border-color: var(--gold); background: var(--white); }
    .empty-state { text-align: center; padding: 50px 20px; color: var(--gray); font-size: 13px; letter-spacing: 1px; }

    .image-upload { display: flex; flex-direction: column; gap: 10px; }
    .image-preview { width: 100%; max-height: 150px; object-fit: cover; border: 1px solid var(--sand); display: none; }
    .image-preview.has-image { display: block; }
    .image-input { padding: 10px; background: var(--cream); border: 1px dashed var(--sand); cursor: pointer; text-align: center; font-size: 12px; color: var(--gray); }
    .image-input:hover { border-color: var(--gold); }
    .image-remove { font-size: 11px; color: var(--danger); cursor: pointer; text-align: right; display: none; }
    .image-remove.has-image { display: block; }

    .checkbox-group { display: flex; align-items: center; gap: 10px; }
    .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .date-range { display: none; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
    .date-range.visible { display: grid; }
    .closed-badge { background: var(--danger); color: white; font-size: 9px; padding: 2px 6px; margin-left: 8px; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-brand">
      <img src="https://hotelcanquetglas.com/wp-content/uploads/2023/05/logobbm3-1.png" alt="Logo" onerror="this.style.display='none'">
      <div class="header-title">Can Quetglas<span>Panel de Administraci√≥n</span></div>
    </div>
    <div class="header-actions">
      <a href="/display" target="_blank" class="btn btn-secondary">Ver Display</a>
      <button class="btn btn-primary" onclick="saveAllSettings()">Guardar</button>
    </div>
  </header>
  <main class="main">
    <div class="tabs">
      <button class="tab active" data-tab="general">General</button>
      <button class="tab" data-tab="schedule">Horarios</button>
      <button class="tab" data-tab="services">Servicios</button>
      <button class="tab" data-tab="display">Display</button>
    </div>
    <div class="section active" id="section-general">
      <div class="card"><div class="card-header"><h2 class="card-title">Informaci√≥n del Hotel</h2></div><div class="form-grid"><div class="form-group"><label>Nombre</label><input type="text" id="hotel_name" placeholder="Hotel Can Quetglas"></div><div class="form-group"><label>Tel√©fono</label><input type="text" id="hotel_phone" placeholder="+34 871 626 000"></div><div class="form-group full-width"><label>Direcci√≥n</label><input type="text" id="hotel_address" placeholder="Calle Santa Rita, 13"></div></div></div>
      <div class="card"><div class="card-header"><h2 class="card-title">WiFi</h2></div><div class="form-grid"><div class="form-group"><label>Red</label><input type="text" id="wifi_network" placeholder="Hotel Can Quetglas"></div><div class="form-group"><label>Contrase√±a</label><input type="text" id="wifi_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div></div></div>
      <div class="card"><div class="card-header"><h2 class="card-title">Mensaje de Bienvenida</h2></div><div class="form-grid"><div class="form-group full-width"><label><span class="lang-badge es">ES</span></label><input type="text" id="welcome_message_es" placeholder="¬°Bienvenidos!"></div><div class="form-group full-width"><label><span class="lang-badge en">EN</span></label><input type="text" id="welcome_message_en" placeholder="Welcome!"></div><div class="form-group full-width"><label><span class="lang-badge de">DE</span></label><input type="text" id="welcome_message_de" placeholder="Willkommen!"></div></div></div>
    </div>
    <div class="section" id="section-schedule"><div class="card"><div class="card-header"><h2 class="card-title">Horarios</h2><button class="btn btn-primary btn-small" onclick="openScheduleModal()">+ A√±adir</button></div><div class="items-list" id="schedule-list"></div></div></div>
    <div class="section" id="section-services"><div class="card"><div class="card-header"><h2 class="card-title">Servicios</h2><button class="btn btn-primary btn-small" onclick="openServiceModal()">+ A√±adir</button></div><div class="items-list" id="services-list"></div></div></div>
    <div class="section" id="section-display">
      <div class="card"><div class="card-header"><h2 class="card-title">Configuraci√≥n</h2></div><div class="form-grid"><div class="form-group"><label>Duraci√≥n Slides (ms)</label><input type="number" id="slide_duration" placeholder="12000" min="5000"></div></div></div>
      <div class="card"><div class="card-header"><h2 class="card-title">Clima</h2></div><div class="form-grid"><div class="form-group full-width"><label>API Key (openweathermap.org)</label><input type="text" id="weather_api_key" placeholder="Tu API Key"></div><div class="form-group"><label>Latitud</label><input type="text" id="weather_lat" placeholder="39.5696"></div><div class="form-group"><label>Longitud</label><input type="text" id="weather_lon" placeholder="2.6502"></div></div></div>
    </div>
  </main>

  <div class="modal-overlay" id="schedule-modal"><div class="modal"><div class="modal-header"><h3 class="modal-title" id="schedule-modal-title">A√±adir Horario</h3><button class="modal-close" onclick="closeScheduleModal()">√ó</button></div><input type="hidden" id="schedule-edit-id"><input type="hidden" id="schedule-image-path"><div class="form-grid"><div class="form-group"><label><span class="lang-badge es">ES</span></label><input type="text" id="schedule-name-es" placeholder="Desayuno"></div><div class="form-group"><label><span class="lang-badge en">EN</span></label><input type="text" id="schedule-name-en" placeholder="Breakfast"></div><div class="form-group"><label><span class="lang-badge de">DE</span></label><input type="text" id="schedule-name-de" placeholder="Fr√ºhst√ºck"></div><div class="form-group"><label>Hora Inicio</label><input type="time" id="schedule-time-start"></div><div class="form-group"><label>Hora Fin</label><input type="time" id="schedule-time-end"></div><div class="form-group"><label>Orden</label><input type="number" id="schedule-order" value="0"></div>
<div class="form-group full-width"><label>Foto</label><div class="image-upload"><img id="schedule-image-preview" class="image-preview" src="" alt=""><label class="image-input" for="schedule-image-input">Haz clic para subir una imagen</label><input type="file" id="schedule-image-input" accept="image/*" style="display:none" onchange="handleImageUpload(this, 'schedule')"><span id="schedule-image-remove" class="image-remove" onclick="removeImage('schedule')">Eliminar imagen</span></div></div>
<div class="form-group full-width"><div class="checkbox-group"><input type="checkbox" id="schedule-is-closed" onchange="toggleClosedDates()"><label for="schedule-is-closed" style="cursor:pointer">Cerrado temporalmente</label></div><div class="date-range" id="schedule-closed-range"><div class="form-group"><label>Cerrado desde</label><input type="date" id="schedule-closed-from"></div><div class="form-group"><label>Cerrado hasta</label><input type="date" id="schedule-closed-to"></div></div></div>
<div class="form-group full-width"><label>Icono</label><div class="icon-selector" id="schedule-icon-selector"><button type="button" class="icon-option" data-icon="coffee">‚òï</button><button type="button" class="icon-option" data-icon="log-out">üö™</button><button type="button" class="icon-option" data-icon="waves">üèä</button><button type="button" class="icon-option" data-icon="concierge-bell">üõéÔ∏è</button><button type="button" class="icon-option" data-icon="utensils">üçΩÔ∏è</button><button type="button" class="icon-option" data-icon="sun">‚òÄÔ∏è</button></div><input type="hidden" id="schedule-icon" value="coffee"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeScheduleModal()">Cancelar</button><button class="btn btn-primary" onclick="saveScheduleItem()">Guardar</button></div></div></div>

  <div class="modal-overlay" id="service-modal"><div class="modal"><div class="modal-header"><h3 class="modal-title" id="service-modal-title">A√±adir Servicio</h3><button class="modal-close" onclick="closeServiceModal()">√ó</button></div><input type="hidden" id="service-edit-id"><input type="hidden" id="service-image-path"><div class="form-grid"><div class="form-group"><label><span class="lang-badge es">ES</span></label><input type="text" id="service-name-es" placeholder="Piscina"></div><div class="form-group"><label><span class="lang-badge en">EN</span></label><input type="text" id="service-name-en" placeholder="Pool"></div><div class="form-group"><label><span class="lang-badge de">DE</span></label><input type="text" id="service-name-de" placeholder="Pool"></div><div class="form-group full-width"><label><span class="lang-badge es">ES</span> Descripci√≥n</label><textarea id="service-desc-es"></textarea></div><div class="form-group full-width"><label><span class="lang-badge en">EN</span> Description</label><textarea id="service-desc-en"></textarea></div><div class="form-group full-width"><label><span class="lang-badge de">DE</span> Beschreibung</label><textarea id="service-desc-de"></textarea></div><div class="form-group"><label>Orden</label><input type="number" id="service-order" value="0"></div>
<div class="form-group full-width"><label>Foto</label><div class="image-upload"><img id="service-image-preview" class="image-preview" src="" alt=""><label class="image-input" for="service-image-input">Haz clic para subir una imagen</label><input type="file" id="service-image-input" accept="image/*" style="display:none" onchange="handleImageUpload(this, 'service')"><span id="service-image-remove" class="image-remove" onclick="removeImage('service')">Eliminar imagen</span></div></div>
<div class="form-group full-width"><label>Icono</label><div class="icon-selector" id="service-icon-selector"><button type="button" class="icon-option" data-icon="waves">üèä</button><button type="button" class="icon-option" data-icon="wifi">üì∂</button><button type="button" class="icon-option" data-icon="car">üöó</button><button type="button" class="icon-option" data-icon="sun">‚òÄÔ∏è</button><button type="button" class="icon-option" data-icon="spa">üíÜ</button><button type="button" class="icon-option" data-icon="gym">üí™</button><button type="button" class="icon-option" data-icon="utensils">üçΩÔ∏è</button><button type="button" class="icon-option" data-icon="coffee">‚òï</button></div><input type="hidden" id="service-icon" value="waves"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeServiceModal()">Cancelar</button><button class="btn btn-primary" onclick="saveServiceItem()">Guardar</button></div></div></div>

  <div class="toast" id="toast"></div>

  <script>
    const icons = { 'coffee': '‚òï', 'log-out': 'üö™', 'waves': 'üèä', 'concierge-bell': 'üõéÔ∏è', 'wifi': 'üì∂', 'car': 'üöó', 'sun': '‚òÄÔ∏è', 'utensils': 'üçΩÔ∏è', 'spa': 'üíÜ', 'gym': 'üí™', 'default': '‚ú¶' };
    let settings = {}, scheduleItems = [], serviceItems = [];

    async function init() { await loadSettings(); await loadSchedule(); await loadServices(); setupTabs(); setupIconSelectors(); }

    async function loadSettings() { try { settings = await (await fetch('/api/settings')).json(); ['hotel_name','hotel_address','hotel_phone','wifi_network','wifi_password','welcome_message_es','welcome_message_en','welcome_message_de','slide_duration','weather_api_key','weather_lat','weather_lon'].forEach(f => { const el = document.getElementById(f); if (el && settings[f]) el.value = settings[f]; }); } catch (e) {} }
    async function loadSchedule() { try { scheduleItems = await (await fetch('/api/schedule')).json(); renderScheduleList(); } catch (e) {} }
    async function loadServices() { try { serviceItems = await (await fetch('/api/services')).json(); renderServicesList(); } catch (e) {} }

    async function saveAllSettings() { const fields = ['hotel_name','hotel_address','hotel_phone','wifi_network','wifi_password','welcome_message_es','welcome_message_en','welcome_message_de','slide_duration','weather_api_key','weather_lat','weather_lon']; const data = {}; fields.forEach(f => { const el = document.getElementById(f); if (el) data[f] = el.value; }); try { const r = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); if (r.ok) showToast('Guardado', 'success'); } catch (e) { showToast('Error', 'error'); } }

    function renderScheduleList() { const c = document.getElementById('schedule-list'); if (!scheduleItems.length) { c.innerHTML = '<div class="empty-state">No hay horarios</div>'; return; } c.innerHTML = scheduleItems.map(i => { const closedBadge = i.is_closed ? '<span class="closed-badge">CERRADO</span>' : ''; return `<div class="item-row"><div class="item-icon">${icons[i.icon]||icons.default}</div><div class="item-name">${i.name_es}${closedBadge}</div><div class="item-detail">${i.name_en||''}</div><div class="item-detail">${i.time_end?i.time_start+' ‚Äì '+i.time_end:i.time_start}</div><div class="item-actions"><button class="btn btn-secondary btn-small" onclick="editScheduleItem(${i.id})">‚úèÔ∏è</button><button class="btn btn-danger btn-small" onclick="deleteScheduleItem(${i.id})">üóëÔ∏è</button></div></div>`; }).join(''); }
    function renderServicesList() { const c = document.getElementById('services-list'); if (!serviceItems.length) { c.innerHTML = '<div class="empty-state">No hay servicios</div>'; return; } c.innerHTML = serviceItems.map(i => `<div class="item-row"><div class="item-icon">${icons[i.icon]||icons.default}</div><div class="item-name">${i.name_es}</div><div class="item-detail">${i.name_en||''}</div><div class="item-detail">${(i.description_es||'').substring(0,20)}...</div><div class="item-actions"><button class="btn btn-secondary btn-small" onclick="editServiceItem(${i.id})">‚úèÔ∏è</button><button class="btn btn-danger btn-small" onclick="deleteServiceItem(${i.id})">üóëÔ∏è</button></div></div>`).join(''); }

    function openScheduleModal(item=null) {
      document.getElementById('schedule-modal').classList.add('active');
      document.getElementById('schedule-modal-title').textContent = item ? 'Editar Horario' : 'A√±adir Horario';
      document.getElementById('schedule-edit-id').value = item?.id||'';
      document.getElementById('schedule-name-es').value = item?.name_es||'';
      document.getElementById('schedule-name-en').value = item?.name_en||'';
      document.getElementById('schedule-name-de').value = item?.name_de||'';
      document.getElementById('schedule-time-start').value = item?.time_start||'';
      document.getElementById('schedule-time-end').value = item?.time_end||'';
      document.getElementById('schedule-order').value = item?.display_order||0;
      document.getElementById('schedule-icon').value = item?.icon||'coffee';
      selectIcon('schedule-icon-selector', item?.icon||'coffee');
      // Image
      document.getElementById('schedule-image-path').value = item?.image||'';
      const preview = document.getElementById('schedule-image-preview');
      const removeBtn = document.getElementById('schedule-image-remove');
      if (item?.image) { preview.src = item.image; preview.classList.add('has-image'); removeBtn.classList.add('has-image'); }
      else { preview.src = ''; preview.classList.remove('has-image'); removeBtn.classList.remove('has-image'); }
      // Closed status
      document.getElementById('schedule-is-closed').checked = item?.is_closed || false;
      document.getElementById('schedule-closed-from').value = item?.closed_from || '';
      document.getElementById('schedule-closed-to').value = item?.closed_to || '';
      toggleClosedDates();
    }
    function closeScheduleModal() { document.getElementById('schedule-modal').classList.remove('active'); document.getElementById('schedule-image-input').value = ''; }
    function editScheduleItem(id) { const item = scheduleItems.find(i => i.id === id); if (item) openScheduleModal(item); }
    async function saveScheduleItem() {
      const id = document.getElementById('schedule-edit-id').value;
      const data = {
        name_es: document.getElementById('schedule-name-es').value,
        name_en: document.getElementById('schedule-name-en').value,
        name_de: document.getElementById('schedule-name-de').value,
        time_start: document.getElementById('schedule-time-start').value,
        time_end: document.getElementById('schedule-time-end').value,
        icon: document.getElementById('schedule-icon').value,
        image: document.getElementById('schedule-image-path').value || null,
        is_closed: document.getElementById('schedule-is-closed').checked ? 1 : 0,
        closed_from: document.getElementById('schedule-closed-from').value || null,
        closed_to: document.getElementById('schedule-closed-to').value || null,
        display_order: parseInt(document.getElementById('schedule-order').value)||0,
        active: 1
      };
      try {
        const r = await fetch(id ? `/api/schedule/${id}` : '/api/schedule', { method: id ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if (r.ok) { closeScheduleModal(); await loadSchedule(); showToast('Guardado', 'success'); }
      } catch (e) { showToast('Error', 'error'); }
    }
    async function deleteScheduleItem(id) { if (!confirm('¬øEliminar?')) return; try { await fetch(`/api/schedule/${id}`, { method: 'DELETE' }); await loadSchedule(); showToast('Eliminado', 'success'); } catch (e) {} }

    function openServiceModal(item=null) {
      document.getElementById('service-modal').classList.add('active');
      document.getElementById('service-modal-title').textContent = item ? 'Editar Servicio' : 'A√±adir Servicio';
      document.getElementById('service-edit-id').value = item?.id||'';
      document.getElementById('service-name-es').value = item?.name_es||'';
      document.getElementById('service-name-en').value = item?.name_en||'';
      document.getElementById('service-name-de').value = item?.name_de||'';
      document.getElementById('service-desc-es').value = item?.description_es||'';
      document.getElementById('service-desc-en').value = item?.description_en||'';
      document.getElementById('service-desc-de').value = item?.description_de||'';
      document.getElementById('service-order').value = item?.display_order||0;
      document.getElementById('service-icon').value = item?.icon||'waves';
      selectIcon('service-icon-selector', item?.icon||'waves');
      // Image
      document.getElementById('service-image-path').value = item?.image||'';
      const preview = document.getElementById('service-image-preview');
      const removeBtn = document.getElementById('service-image-remove');
      if (item?.image) { preview.src = item.image; preview.classList.add('has-image'); removeBtn.classList.add('has-image'); }
      else { preview.src = ''; preview.classList.remove('has-image'); removeBtn.classList.remove('has-image'); }
    }
    function closeServiceModal() { document.getElementById('service-modal').classList.remove('active'); document.getElementById('service-image-input').value = ''; }
    function editServiceItem(id) { const item = serviceItems.find(i => i.id === id); if (item) openServiceModal(item); }
    async function saveServiceItem() {
      const id = document.getElementById('service-edit-id').value;
      const data = {
        name_es: document.getElementById('service-name-es').value,
        name_en: document.getElementById('service-name-en').value,
        name_de: document.getElementById('service-name-de').value,
        description_es: document.getElementById('service-desc-es').value,
        description_en: document.getElementById('service-desc-en').value,
        description_de: document.getElementById('service-desc-de').value,
        icon: document.getElementById('service-icon').value,
        image: document.getElementById('service-image-path').value || null,
        display_order: parseInt(document.getElementById('service-order').value)||0,
        active: 1
      };
      try {
        const r = await fetch(id ? `/api/services/${id}` : '/api/services', { method: id ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if (r.ok) { closeServiceModal(); await loadServices(); showToast('Guardado', 'success'); }
      } catch (e) { showToast('Error', 'error'); }
    }
    async function deleteServiceItem(id) { if (!confirm('¬øEliminar?')) return; try { await fetch(`/api/services/${id}`, { method: 'DELETE' }); await loadServices(); showToast('Eliminado', 'success'); } catch (e) {} }

    function setupTabs() { document.querySelectorAll('.tab').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); tab.classList.add('active'); document.getElementById(`section-${tab.dataset.tab}`).classList.add('active'); }); }); }
    function setupIconSelectors() { document.querySelectorAll('.icon-selector').forEach(sel => { sel.querySelectorAll('.icon-option').forEach(opt => { opt.addEventListener('click', () => { sel.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected')); opt.classList.add('selected'); document.getElementById(sel.id.replace('-selector', '')).value = opt.dataset.icon; }); }); }); }
    function selectIcon(selId, icon) { document.getElementById(selId).querySelectorAll('.icon-option').forEach(o => o.classList.toggle('selected', o.dataset.icon === icon)); }
    function showToast(msg, type='info') { const t = document.getElementById('toast'); t.textContent = msg; t.className = `toast ${type} show`; setTimeout(() => t.classList.remove('show'), 3000); }

    // Image upload handling
    async function handleImageUpload(input, type) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
        const base64 = e.target.result;
        try {
          showToast('Subiendo imagen...', 'info');
          const res = await fetch('/api/upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: base64, filename: file.name })
          });
          const data = await res.json();
          if (data.path) {
            document.getElementById(`${type}-image-path`).value = data.path;
            const preview = document.getElementById(`${type}-image-preview`);
            preview.src = data.path;
            preview.classList.add('has-image');
            document.getElementById(`${type}-image-remove`).classList.add('has-image');
            showToast('Imagen subida', 'success');
          }
        } catch (err) { showToast('Error al subir', 'error'); }
      };
      reader.readAsDataURL(file);
    }

    function removeImage(type) {
      document.getElementById(`${type}-image-path`).value = '';
      document.getElementById(`${type}-image-preview`).src = '';
      document.getElementById(`${type}-image-preview`).classList.remove('has-image');
      document.getElementById(`${type}-image-remove`).classList.remove('has-image');
      document.getElementById(`${type}-image-input`).value = '';
    }

    function toggleClosedDates() {
      const checkbox = document.getElementById('schedule-is-closed');
      const range = document.getElementById('schedule-closed-range');
      if (checkbox.checked) { range.classList.add('visible'); }
      else { range.classList.remove('visible'); }
    }

    init();
  </script>
</body>
</html>
